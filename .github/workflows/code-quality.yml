name: Code Quality

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format=json --output-file=eslint-report.json
        continue-on-error: true

      - name: ESLint Annotations
        uses: 'aseure/ESLint-Annotations@v1'
        if: always()
        with:
          report-json: eslint-report.json

      - name: Check code complexity
        run: |
          npx complexity-report --output json --format json src/ > complexity-report.json
          npx ts-unused-exports tsconfig.json

      - name: Check bundle size
        uses: 'preactjs/compressed-size-action@v2'
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          pattern: "./dist/**/*.{js,css,html}"
          exclude: "{./dist/**/*.map,./dist/**/*.{br,gz}}"

      - name: Check for secrets
        uses: 'secretlint/secretlint-action@v1'
        with:
          path: 'src/**/*.{js,ts,jsx,tsx,json}'
          secretlintignore_file: '.secretlintignore'

      - name: Run TypeScript compiler
        run: npm run typecheck